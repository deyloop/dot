#!/usr/bin/bash

: "${GITHUB_USER:="$USER"}"
: "${REPOS_DIR:="$HOME/repos"}"
: "${NOTEBOX_ROOT_DIR:="$REPOS_DIR/github.com/$GITHUB_USER/notebox"}"
: "${EDITOR:=vim}"

nb_create() {
  local title note_dir
  title="$*"

  note_dir="$NOTEBOX_ROOT_DIR/$(isosec)"
  mkdir -p "$note_dir"

  echo "# $title" >> "$note_dir/README.md"
  command $EDITOR "$note_dir/README.md"

  if [[ -z $title ]]; then return; fi

  read -rp "Commit? " ans
  if [[ $ans =~ [Yy].* ]]; then
    cd "$NOTEBOX_ROOT_DIR" && git add "$note_dir" && git commit -m "$title"
  fi
}

nb_search() {
  cd "$NOTEBOX_ROOT_DIR"
  local results="$( git grep --color -nir "${@//\ /\.\*}" )"
  local -A resultFiles
  while IFS= read -r line
  do
    if [[ $line =~ ([^:]*):(.*) ]]; then
      local file_name="${BASH_REMATCH[1]}"
      local result_line="${BASH_REMATCH[2]}"

      resultFiles[${file_name%/*}]+="$result_line"
      resultFiles[${file_name%/*}]+=$'\n'
    fi
  done < <(echo "$results")
  
  for i in "${!resultFiles[@]}"
  do
    echo -e "\e[1;32m$i"
    echo "${resultFiles[$i]}"
  done
}

nb_title() {
  local id
  id="$1"
  
  local title="$(head -1 "$NOTEBOX_ROOT_DIR/$id/README.md")"
  echo "${title### }"
}

nb_list() {
  for dir in $(nb_list_ids); do
    printf "%s %s\n" "$dir" "$(nb_title "$dir")"
  done
}

nb_list_ids() {
  cd "$NOTEBOX_ROOT_DIR"
  local list=$(ls -1 -d */)
  list="${list//\//}"
  echo "$list"
}

nb_last() {
  nb_list_ids | tail -1
}

nb_open() {
  local id
  id="$1"
  
  [[ "$id" = "last" ]] && id="$(nb_last)"
  command $EDITOR "$NOTEBOX_ROOT_DIR/$id/README.md"

}

nb_edit() {
  local id
  id="$1"

  [[ "$id" = "last" ]] && id="$(nb_last)"
  
  nb_open "$id"

  read -rp "Commit? " ans
  if [[ $ans =~ [Yy].* ]]; then
    cd "$NOTEBOX_ROOT_DIR" && \
    git add "$id" && \
    git commit -m "$(nb_title "$id")"
  fi

  read -rp "Push? " ans
  if [[ $ans =~ [Yy].* ]]; then
    cd "$NOTEBOX_ROOT_DIR" && \
    git push
  fi

}

_nb(){
  local cmd
  if [[ -n "$1" ]]; then
    cmd="$1"; shift
  fi

  case "$cmd" in
    create) nb_create "$@" ;;
    search) nb_search "$@" ;;
    title) nb_title "$1" ;;
    list) nb_list ;;
    last) nb_last ;;
    open) nb_open "$1" ;;
    edit) nb_edit "$1" ;;
    "" | * ) return 1 ;;
  esac
}

_nb "$@"
